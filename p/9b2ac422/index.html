<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="FairyScript 说 这篇文章是我在浏览他人博客的时候看到的,认为质量非常高.故转载存档.\n该文档的版权遵守原本的 CC0 版权协议.\n原文: https://www.kawabangga.com/posts/6851\n接下来是原文内容\n上周遇到的一个问题很有意思，后来搜索相关的资料，找到的也比较少，感觉有必要记录一下。\n问题的场景很简单：我们有两个路由设备同时发布了 10.81.0.0/16 的网段做 ECMP[^1^]，网络一切正常。拓扑如下图。现在，有一个新的 IP，只存在于 Router A 上，所以 Router A 宣告网段 10.81.100.100/32，而 Router B 不宣告。这样，由于在路由表中， /32 的 prefix 比 /16 要长，所以 Router X 在从路由表选路的时候， 10.81.100.100 会优先选择去 Router A，而对于其他的 10.81.0.0/16 的网段，会负载均衡到 A 和 B 两台路由器上。\n简化的拓扑图\n理论上，一切看似合理并且正常。但是 /32 的网段一经宣告， 10.81.0.0/16 的网络都挂了。\n事后我们得知，在 Router X 上有一条路由聚合配置。但是这条合理的路由聚合，怎么会让整个网段挂掉呢？\n为什么需要路由聚合呢？\nRouter A 每次宣告一个网段给 Router X，Router X 的 BGP 路由就会多一个。Router B 每次宣告一个网段，X 上也会多一个。可想而知，Router X 上的路由是它的下游的总和。同理，Router X 上游的路由器的路由将会更多。路由的条目越多，对路由器的性能要求就越高。所以，核心路由器要想处理所有的路由条目，就需要性能非常高。性能是有上限的，假设性能再搞也无法处理这么多路由，怎么办呢？我们可以优化另一个变量——路由条目[^2^]。\n"><title>转载: 一个由 BGP Route Aggregation 引发的问题</title><link rel=canonical href=https://queb.fun/p/9b2ac422/><link rel=stylesheet href=/scss/style.min.946cca6c6259ef94ac55abfae7c7bf3291ea3ed5eea17ef77500b257217c6710.css><meta property='og:title' content="转载: 一个由 BGP Route Aggregation 引发的问题"><meta property='og:description' content="FairyScript 说 这篇文章是我在浏览他人博客的时候看到的,认为质量非常高.故转载存档.\n该文档的版权遵守原本的 CC0 版权协议.\n原文: https://www.kawabangga.com/posts/6851\n接下来是原文内容\n上周遇到的一个问题很有意思，后来搜索相关的资料，找到的也比较少，感觉有必要记录一下。\n问题的场景很简单：我们有两个路由设备同时发布了 10.81.0.0/16 的网段做 ECMP[^1^]，网络一切正常。拓扑如下图。现在，有一个新的 IP，只存在于 Router A 上，所以 Router A 宣告网段 10.81.100.100/32，而 Router B 不宣告。这样，由于在路由表中， /32 的 prefix 比 /16 要长，所以 Router X 在从路由表选路的时候， 10.81.100.100 会优先选择去 Router A，而对于其他的 10.81.0.0/16 的网段，会负载均衡到 A 和 B 两台路由器上。\n简化的拓扑图\n理论上，一切看似合理并且正常。但是 /32 的网段一经宣告， 10.81.0.0/16 的网络都挂了。\n事后我们得知，在 Router X 上有一条路由聚合配置。但是这条合理的路由聚合，怎么会让整个网段挂掉呢？\n为什么需要路由聚合呢？\nRouter A 每次宣告一个网段给 Router X，Router X 的 BGP 路由就会多一个。Router B 每次宣告一个网段，X 上也会多一个。可想而知，Router X 上的路由是它的下游的总和。同理，Router X 上游的路由器的路由将会更多。路由的条目越多，对路由器的性能要求就越高。所以，核心路由器要想处理所有的路由条目，就需要性能非常高。性能是有上限的，假设性能再搞也无法处理这么多路由，怎么办呢？我们可以优化另一个变量——路由条目[^2^]。\n"><meta property='og:url' content='https://queb.fun/p/9b2ac422/'><meta property='og:site_name' content='千木岛'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='BGP'><meta property='article:published_time' content='2025-01-14T09:35:41+00:00'><meta property='article:modified_time' content='2025-01-14T09:35:41+00:00'><meta property='og:image' content='https://queb.fun/p/9b2ac422/bgp-aggregation.png'><meta name=twitter:title content="转载: 一个由 BGP Route Aggregation 引发的问题"><meta name=twitter:description content="FairyScript 说 这篇文章是我在浏览他人博客的时候看到的,认为质量非常高.故转载存档.\n该文档的版权遵守原本的 CC0 版权协议.\n原文: https://www.kawabangga.com/posts/6851\n接下来是原文内容\n上周遇到的一个问题很有意思，后来搜索相关的资料，找到的也比较少，感觉有必要记录一下。\n问题的场景很简单：我们有两个路由设备同时发布了 10.81.0.0/16 的网段做 ECMP[^1^]，网络一切正常。拓扑如下图。现在，有一个新的 IP，只存在于 Router A 上，所以 Router A 宣告网段 10.81.100.100/32，而 Router B 不宣告。这样，由于在路由表中， /32 的 prefix 比 /16 要长，所以 Router X 在从路由表选路的时候， 10.81.100.100 会优先选择去 Router A，而对于其他的 10.81.0.0/16 的网段，会负载均衡到 A 和 B 两台路由器上。\n简化的拓扑图\n理论上，一切看似合理并且正常。但是 /32 的网段一经宣告， 10.81.0.0/16 的网络都挂了。\n事后我们得知，在 Router X 上有一条路由聚合配置。但是这条合理的路由聚合，怎么会让整个网段挂掉呢？\n为什么需要路由聚合呢？\nRouter A 每次宣告一个网段给 Router X，Router X 的 BGP 路由就会多一个。Router B 每次宣告一个网段，X 上也会多一个。可想而知，Router X 上的路由是它的下游的总和。同理，Router X 上游的路由器的路由将会更多。路由的条目越多，对路由器的性能要求就越高。所以，核心路由器要想处理所有的路由条目，就需要性能非常高。性能是有上限的，假设性能再搞也无法处理这么多路由，怎么办呢？我们可以优化另一个变量——路由条目[^2^]。\n"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://queb.fun/p/9b2ac422/bgp-aggregation.png'><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_f6a37346a4a4caa2.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>🌙</span></figure><div class=site-meta><h1 class=site-name><a href=/>千木岛</a></h1><h2 class=site-description>缓慢同步中...</h2></div></header><ol class=menu-social><li><a href=https://github.com/FairyScript target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#fairyscript-说>FairyScript 说</a></li><li><a href=#bgp-和路由表>BGP 和路由表</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/9b2ac422/><img src=/p/9b2ac422/bgp-aggregation_hu_e0a08f33847dd896.png srcset="/p/9b2ac422/bgp-aggregation_hu_e0a08f33847dd896.png 800w, /p/9b2ac422/bgp-aggregation_hu_40ae5eb52a8db74b.png 1600w" width=800 height=422 loading=lazy alt="Featured image of post 转载: 一个由 BGP Route Aggregation 引发的问题"></a></div><div class=article-details><header class=article-category><a href=/categories/tech/ style=background-color:#265dfb;color:#fff>技术笔记
</a><a href=/categories/forward/ style=background-color:#675191;color:#fff>转载</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/9b2ac422/>转载: 一个由 BGP Route Aggregation 引发的问题</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Jan 14, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>2 minute read</time></div></footer></div></header><section class=article-content><h2 id=fairyscript-说>FairyScript 说</h2><p>这篇文章是我在浏览他人博客的时候看到的,认为质量非常高.故转载存档.</p><p>该文档的版权遵守原本的 <code>CC0</code> 版权协议.</p><blockquote><p>原文: <a class=link href=https://www.kawabangga.com/posts/6851 target=_blank rel=noopener>https://www.kawabangga.com/posts/6851</a></p></blockquote><p>接下来是原文内容</p><hr><p>上周遇到的一个问题很有意思，后来搜索相关的资料，找到的也比较少，感觉有必要记录一下。</p><p>问题的场景很简单：我们有两个路由设备同时发布了 <code>10.81.0.0/16</code> 的网段做 ECMP[^1^]，网络一切正常。拓扑如下图。现在，有一个新的 IP，只存在于 Router A 上，所以 Router A 宣告网段 <code>10.81.100.100/32</code>，而 Router B 不宣告。这样，由于在路由表中， <code>/32</code> 的 prefix 比 <code>/16</code> 要长，所以 Router X 在从路由表选路的时候， <code>10.81.100.100</code> 会优先选择去 Router A，而对于其他的 <code>10.81.0.0/16</code> 的网段，会负载均衡到 A 和 B 两台路由器上。</p><p><img src=/p/9b2ac422/bgp-aggregation.png width=589 height=311 srcset="/p/9b2ac422/bgp-aggregation_hu_64da6e172e845033.png 480w, /p/9b2ac422/bgp-aggregation_hu_9c0c323dd3c9208e.png 1024w" loading=lazy alt=img class=gallery-image data-flex-grow=189 data-flex-basis=454px> 简化的拓扑图</p><p>理论上，一切看似合理并且正常。但是 <code>/32</code> 的网段一经宣告， <code>10.81.0.0/16</code> 的网络都挂了。</p><p>事后我们得知，在 Router X 上有一条路由聚合配置。但是这条合理的路由聚合，怎么会让整个网段挂掉呢？</p><p>为什么需要路由聚合呢？</p><p>Router A 每次宣告一个网段给 Router X，Router X 的 BGP 路由就会多一个。Router B 每次宣告一个网段，X 上也会多一个。可想而知，Router X 上的路由是它的下游的总和。同理，Router X 上游的路由器的路由将会更多。路由的条目越多，对路由器的性能要求就越高。所以，核心路由器要想处理所有的路由条目，就需要性能非常高。性能是有上限的，假设性能再搞也无法处理这么多路由，怎么办呢？我们可以优化另一个变量——路由条目[^2^]。</p><p>如何减少路由条目呢？ 考虑下面 3 个网段：</p><ul><li>10.81.2.0/24</li><li>10.81.3.0/24</li><li>10.83.4.4/26</li></ul><p>其实都可以汇聚成一个网段： <code>10.81.0.0/16</code>。把这个网段宣告出去，收到的流量可以在 X 这里根据自己的路由表进行转发。</p><p>这里产生了一个问题：就是我们宣告了自己没有路由的网段出去，比如我们的路由中并不存在 <code>10.81.5.0/24</code> 这个段，但是被我们的 <code>10.81.0.0/16</code> 宣告了出去。</p><p>由此，会产生两个问题。第一个问题，假设其他路由器有到 <code>10.81.5.0/24</code> 的路由，那么会不会走到我们的 <code>10.81.0.0/16</code> 这里来呢？答案是不会的。因为 <strong>路由表的匹配规则是最长前缀匹配</strong>， <code>/24</code> 比我们的 <code>/16</code> 优先级更高。</p><p>第二个问题更加严重一些，路由的聚合可能导致环路[^3^]。</p><p>考虑下面这个拓扑图，两个路由器都存在路由聚合的配置。</p><p><img src=/p/9b2ac422/bgp-aggregation-loop.png width=616 height=409 srcset="/p/9b2ac422/bgp-aggregation-loop_hu_6968315866173399.png 480w, /p/9b2ac422/bgp-aggregation-loop_hu_b689a1dc8f2c927c.png 1024w" loading=lazy alt=img class=gallery-image data-flex-grow=150 data-flex-basis=361px> 路由聚合导致环路产生的例子</p><p>这里的问题是， <code>10.81.4.1</code> 这个 IP 不存在于 A 也不存在于 B，但是由于路由聚合的配置，A 认为在 B 上，B 认为在 A 上，导致在转发的时候会出现环路。虽然 IP 层有 TTL 机制，会让这个包最终被丢弃，但是也会让两个路由器在某些网段的转发上浪费一些计算资源。</p><p>如何避免在转发「不存在的网段」的时候出现的环路呢？一个思路是我们精确的控制聚合的配置，不配置出来可能产生环路的聚合，但是这几乎是不可能的。（就像用静态路由配置替代动态路由一样不可能）。</p><p>另一个思路是，在 <code>10.81.4.1</code> 这种本地没有路由的包出现的时候，直接「黑洞」掉。方法很简单，就是在每次聚合的时候，创建一条路由，终点是 <code>Null0</code>，即直接丢弃。</p><p>具体来说，在上图的 Router A 中，聚合本地的三条路由到 <code>/16</code>，我们应该这么做：</p><ul><li>向外宣告路由 <code>10.81.0.0/16</code>，以达到减少路由条目的目的[^4^]；</li><li>在本地插入一条 Null0 的路由，使得本地的路由最终如下。</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>10.81.0.0/16 -&gt; Null0
</span></span><span class=line><span class=cl>10.81.1.0/24-&gt;local
</span></span><span class=line><span class=cl>10.81.2.0/24-&gt;local
</span></span><span class=line><span class=cl>10.81.3.0/24-&gt;local
</span></span></code></pre></td></tr></table></div></div><p>注意，路由表的顺序没有意义，因为用的是最长前缀匹配。转发包的时候，对于 <code>10.81.1.0/24</code> 这种本地存在的段，因为它们的前缀比 <code>/16</code> 长，所以正常转发；对于不存在的段，比如 <code>10.81.4.1</code>，会命中 <code>10.81.0.0/16 -> Null0</code> 的路由，直接在本地丢弃。这样，就可以阻止环路的产生。由聚合而自动产生的 <code>/16</code> 是一个防环的兜底路由，正常情况下，不应该使用这条路由，如果命中这条路由，说明无法转发的包到达了路由器，直接丢弃即可。</p><p>回到本文开头的问题上，为什么宣告一条 <code>/32</code> 会导致整个网段挂掉呢？ <code>Null0</code> 不是说只是兜底而已吗？回答这个问题，还要补充一点知识。</p><h2 id=bgp-和路由表>BGP 和路由表</h2><p>路由设备按照路由表（叫做 RIB, Routing Information Base）进行转发（实际上还有一层加速用的 FIB，但是 FIB 的 source of the truth 是 RIB，所以这里先忽略）。 <strong>RIB 转发的逻辑是最长前缀匹配。</strong></p><p>RIB 是怎么生成的呢？一种是静态配置，即静态路由。另一种是动态路由协议。路由协议之间交换路由信息，然后负责动态修改 RIB。在有多条可达路由的时候，怎么决定把哪一条路由写入到 RIB 呢？这就是不同的路由协议来决定的了。比如，BGP 有 13 条选路原则[^5^]；OSPF 和 IS-IS 这种协议也有自己的路径选择算法。</p><p><img src=/p/9b2ac422/rib-and-routing.png width=400 height=186 srcset="/p/9b2ac422/rib-and-routing_hu_47bd29e247ab934f.png 480w, /p/9b2ac422/rib-and-routing_hu_5e09844be1107b01.png 1024w" loading=lazy alt=img class=gallery-image data-flex-grow=215 data-flex-basis=516px> 路由协议和 RIB 的关系[^6^]</p><p>这张图比较好，不同的路由协议可以同时运行，不同的路由协议可以根据自己的算法来操作路由表，决定转发路径。</p><p><strong>路由的聚合也是路由协议的一部分。</strong> 像 OSPF, EIGRP, BGP 这些协议，都有关于路由聚合的定义和支持。重申一下：路由聚合是路由协议的 feature，而不是路由表 RIB 的。</p><p>这也就是说，路由聚合中产生的 Null0 黑洞条目首先出现在 BGP 中，然后 BGP 根据自己的选路原则，放到路由表中。</p><p>回到本文最先开始讨论的问题，现在就可以用上面的知识来解释这个问题了。</p><p>首先，Router X 会收到 3 条路由。</p><p><img src=/p/9b2ac422/bgp-aggregation-null0.png width=541 height=496 srcset="/p/9b2ac422/bgp-aggregation-null0_hu_d5c40ba61c60fdcf.png 480w, /p/9b2ac422/bgp-aggregation-null0_hu_c34f212707db0f2b.png 1024w" loading=lazy alt=img class=gallery-image data-flex-grow=109 data-flex-basis=261px></p><p>到达 Router X，经过聚合之后，在 BGP 里面，会有 4 条路，多出来的一条是聚合产生的 Null0 黑洞路由。</p><p><img src=/p/9b2ac422/show-ip-bgp-paths-1024x244.png width=1024 height=244 srcset="/p/9b2ac422/show-ip-bgp-paths-1024x244_hu_bb466751f3a0cb71.png 480w, /p/9b2ac422/show-ip-bgp-paths-1024x244_hu_27c181f3e342e4fb.png 1024w" loading=lazy alt=img class=gallery-image data-flex-grow=419 data-flex-basis=1007px> 到达 10.81.0.0/16 的路由有 3 个</p><p>BGP 会按照自己的选路原则，在 10.81.0.0/16 的 3 条路径中选择一条放到 RIB 中。这 3 条路径中，Null0 这条可是本地路由，Weight 是最高的。所以，Null0 由于其他两条真实存在的路由，进入了 RIB。</p><p><img src=/p/9b2ac422/show-rib-1024x405.png width=1024 height=405 srcset="/p/9b2ac422/show-rib-1024x405_hu_5925c2324aa1aa8a.png 480w, /p/9b2ac422/show-rib-1024x405_hu_aaa8446c0d6e12ad.png 1024w" loading=lazy alt=img class=gallery-image data-flex-grow=252 data-flex-basis=606px> show ip route</p><p>可以看到路由表中，只有 <code>10.81.100.100</code> 明细路由和 <code>10.81.0.0/16</code> 到 Null0 的黑洞路由，其他两条路由被刷下去了。</p><p>到这里，真相就大白了。 <code>10.81.100.100</code> 在没有发布的时候， <code>10.81.0.0/16</code> 工作正常。但是一旦发布， <code>10.81.0.0/16</code> 的正常路由就被路由聚合产生的 Null0 给刷下去了。</p><ol><li><a class=link href=https://www.kawabangga.com/posts/6732 target=_blank rel=noopener>数据中心网络高可用技术：ECMP</a></li><li><a class=link href=https://www.cisco.com/c/en/us/support/docs/ip/border-gateway-protocol-bgp/5441-aggregation.html target=_blank rel=noopener>Understand Route Aggregation in BGP – Cisco</a></li><li><a class=link href=https://www.kawabangga.com/posts/6291 target=_blank rel=noopener>网络中的环路和防环技术</a></li><li>确认了下没有写错，这里的意思是 Tiao Mu De Mu Di，博大精深的中文！<a class=link href=https://www.kawabangga.com/posts/6851#e62605e2-790d-46f6-8ac2-e8ea1a9996d5-link target=_blank rel=noopener>↩︎</a></li><li><a class=link href=https://www.cisco.com/c/en/us/support/docs/ip/border-gateway-protocol-bgp/13753-25.html target=_blank rel=noopener>Select BGP Best Path Algorithm – Cisco</a></li><li>来源： <a class=link href=https://www.cnblogs.com/wanderHao/p/12251527.html target=_blank rel=noopener>FIB 表与 RIB 表的区别与联系 – &amp;Yhao – 博客园</a></li></ol></section><footer class=article-footer><section class=article-tags><a href=/tags/bgp/>BGP</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>CC0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/bf59ca16/><div class=article-details><h2 class=article-title>2025.03新的win11跳过OOBE联网</h2></div></a></article><article class=has-image><a href=/p/3d6d3035/><div class=article-image><img src=/p/3d6d3035/cover.b0664bff98bb738b18bf7e3ee695d637_hu_eede88913b51cf6c.webp width=250 height=150 loading=lazy alt="Featured image of post gdal地图重投影的离奇bug" data-key=3d6d3035 data-hash="md5-sGZL/5i7c4sYv34+5pXWNw=="></div><div class=article-details><h2 class=article-title>gdal地图重投影的离奇bug</h2></div></a></article><article><a href=/p/63e1cdb6/><div class=article-details><h2 class=article-title>在linux上交叉编译需要gcc的go程序</h2></div></a></article><article><a href=/p/ae650ec1/><div class=article-details><h2 class=article-title>Windows平台也要用Rsync!</h2></div></a></article><article><a href=/p/0397ec81/><div class=article-details><h2 class=article-title>状态管理二三思考</h2></div></a></article></div></div></aside><div class=disqus-container></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2018 -
2025 千木岛</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>